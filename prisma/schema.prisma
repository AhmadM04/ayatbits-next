// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionStatus {
  FREE
  PRO
  ENTERPRISE
}

enum PuzzleType {
  ORDERING
  FILL_BLANK
  MATCHING
}

enum ProgressStatus {
  COMPLETED
  IN_PROGRESS
}

model User {
  id                String            @id @default(cuid())
  clerkId           String            @unique
  email             String            @unique
  name              String?
  firstName         String?
  lastName          String?
  username          String?
  imageUrl          String?
  selectedTranslation String?         @default("en.sahih")
  subscriptionStatus SubscriptionStatus @default(FREE)
  stripeCustomerId  String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  lastActiveAt      DateTime          @default(now())

  // Relations
  progress          UserProgress[]
  likedAyats        LikedAyat[]
  trophies          Trophy[]

  @@index([clerkId])
  @@index([email])
}

model Juz {
  id                Int               @id @default(autoincrement())
  number            Int               @unique // 1-30
  name              String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  surahs            Surah[]
  puzzles           Puzzle[]

  @@index([number])
}

model Surah {
  id                Int               @id @default(autoincrement())
  number            Int               @unique // 1-114
  nameEnglish       String
  nameArabic        String
  juzId             Int?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  juz               Juz?              @relation(fields: [juzId], references: [id], onDelete: SetNull)
  puzzles           Puzzle[]

  @@index([number])
  @@index([juzId])
}

model Puzzle {
  id                String            @id @default(cuid())
  juzId             Int?
  surahId           Int?
  type              PuzzleType
  content           Json              // The puzzle data (ayah text, words, etc.)
  difficulty        String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  juz               Juz?              @relation(fields: [juzId], references: [id], onDelete: SetNull)
  surah             Surah?             @relation(fields: [surahId], references: [id], onDelete: SetNull)
  userProgress      UserProgress[]
  likedAyats        LikedAyat[]

  @@index([juzId])
  @@index([surahId])
  @@index([type])
}

model UserProgress {
  id                String            @id @default(cuid())
  userId            String
  puzzleId          String
  status            ProgressStatus
  score             Int               @default(0)
  completedAt       DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  puzzle            Puzzle             @relation(fields: [puzzleId], references: [id], onDelete: Cascade)

  @@unique([userId, puzzleId])
  @@index([userId])
  @@index([puzzleId])
}

model LikedAyat {
  id                String            @id @default(cuid())
  userId            String
  puzzleId          String
  likedAt           DateTime          @default(now())
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  puzzle            Puzzle             @relation(fields: [puzzleId], references: [id], onDelete: Cascade)

  @@unique([userId, puzzleId])
  @@index([userId])
  @@index([puzzleId])
}

model Trophy {
  id                String            @id @default(cuid())
  userId            String
  surahNumber       Int
  surahName         String
  earnedAt          DateTime          @default(now())
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, surahNumber])
  @@index([userId])
  @@index([surahNumber])
}
